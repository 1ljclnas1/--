# 7. 事务

事务的滥用和过度使用所引入的性能瓶颈应该主要由应用层来解决，而不是简单的抛弃事务。

事务将应用程序的多个读、写操作捆绑在一起成为一个逻辑操作单元。

## 深入理解事务

很多新一代的数据库完全放弃的事务的支持，或者将其重新定义，即替换为比以前弱得多的保证。

但是事务到底可以提供哪些保证呢？

### ACID

事务所提供的安全保证就是ACID。

但是各家数据库所实现的ACID并不一样。光是围绕”隔离性“就有很多争议。ACID更像是市场营销用语。

#### 原子性

这个原子与多线程的原子操作不一样，多线程是其他线程无法看到这个线程原子操作的中间结果，而数据库中对于并发的保证其实是在隔离性中。

这里的原子性是为了，当客户提交一个或多个操作的时候如果执行了一半发生了故障或违反了完整性约束，那么数据库应该丢弃局部完成的结果，即终止事务。

#### 一致性

一致性在不同的场景有不同含义

- 第五章讨论副本一致性以及异步复制模型时，引出了最终一致性问题。

- 一致性哈希是某些系统用于区分动态分区再平衡的方法

- CAP理论中，一致性表示线性化

- 而ACID中，一致性主要指数据库处于应用程序所期待的”预期状态“

一致性更多是应用层的属性。应用程序有责任正确地定义事务来保持一致性。这不是数据库可以保证的事情：即如果提供的数据修改违背了恒等条件，数据库很难检测进而阻止该操作（数据库可以完成针对某些特定类型的恒等约束检查，例如使用外键约束或唯一性约束。但主要靠应用程序来定义数据的有效/无效状态，数据库主要负责存储）。应用程序可能借助原子性、隔离性以达到一致性。

#### 隔离性

多个客户端访问相同数据，可能带来并发问题。

可以把隔离定义为可串行化，即数据库系统保证事务提交时，其结果与串行执行（一个一个）完全相同。

#### 持久性

 保证一旦事务提交成功，即使硬件故障或者数据库崩溃，事务所写入的数据也不会消失。没有可以绝对保证持久性的技术，都是帮助降低风险的手段，需要组合使用。

### 单对象与多对象事务操作
