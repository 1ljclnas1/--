信号机制由三部分构成

信号是怎么产生的，怎么投递到进程或线程的，最后是信号是怎么处理的。

![](C:\Users\ljc\Documents\GitHub\--\C++\信号机制\图片\信号机制框架.png)

这里的内核发送指的是，内核里的异常处理的信号发送，也就是一个进程给另一个进程发送或者是给自己发送。

信号可以发送给进程，但是信号的处理是在线程中，因为线程是执行的基本单元。线程首先处理自己的信号队列，再去处理进程的信号队列。处理的时候要考虑掩码，被掩码阻塞的暂时不处理，还放回队列中。

信号处理有三种方式，不做设置走默认处理

默认处理有五种情况，ignore，term，core，stop，cont。

还有两种方式是进程提前通过接口函数**signal**或者**sigaction**设置了处理方式，设置IGN来忽略信号，或者设置一个信号处理函数handler来处理信号。注意，默认处理中的忽略和进程主动设置的忽略，两者的逻辑是不同的，一个是默认处理是忽略，一个是进程主动要求忽略。

## 信号类型简介

1-31标准信号会丢失，也叫不可靠信号。32-64这33个信号作为实时信号，并规定实时信号不能丢失，要用队列来实现。

## 同步信号与异步信号

信号本身没有同步异步之分，信号的发送有同步异步之分。

## 信号的处理时机

并不是在被投递的时候处理。在县城将要返回用户空间之前进行处理的。线程返回用户空间有两种情况，一是从系统调用返回，而是从中断返回。返回之前，线程会检查队列里有没有信号要处理，有的话就处理

## 信号与多线程

信号的发送即可以给进程，也可以给线程，但是同步信号应当发送给当前线程。进程发送信号可以选择不同的接口函数，有的是发给进程，有的接口是发给线程。线程信号队列中的信号只能由线程自己处理，进程信号队列有线程处理，具体哪个线程不确定

信号掩码是线程私有的，

信号处理方式的设置是进程全局的，后面线程设置的方式会覆盖前面的线程的设置。

信号处理的效果是进程全局的。

# 信号类型详解

## 标准信号与实时信号的区别

最大的区别就是在信号处于待决的状态下又来了同样的信号会怎么处理。还有另外三个不同：

1. 实时信号如果使用接口sigqueue发送的话，可以携带一个额外的整数信息或者指针信息。

2. 实时信号有优先级，数值越小优先级越高，优先级越高的优先处理，同等优先级的按照先来后到的顺序处理

3. 标准信号都是预定义信号，每个信号都有特定的含义，而实时信号没有预定义的含义

## 信号的属性特征

### 可阻塞（屏蔽）

### 可忽略

有些默认是可忽略的。但是内核在异常处理时会强制发送信号，这时忽略是无效的。不过同样的信号用kill发，忽略就是有效的，因为kill不是强制发送的。阻塞是暂时不处理，而忽略是空处理

### 可捕获

可以通过设置信号处理函数handler来处理信号，这个行为叫做捕获。有些信号是能捕获的，有些是不能捕获的。强制发送的信号也是可捕获的。但是可捕获存在一个特殊情况，有些时候是不能二次捕获的。

### 默认处理

没有设置忽略和捕获函数时，对信号使用默认处理方式。

## 标准信号

0，会走检测流程但是不会真的投递，可用来检测进程是否存在

32，33被pthread用了

1-31共31个

## 内核发送

SIGSEGV 一般是在缺页异常里，如果访问的虚拟内存是未分配的虚拟内存，则会发生SIGSEGV。。。。。

## 进程发送

使用接口函数，如kill，killpg，pthread_kill, tgkill等。

# 信号投递

每个线程有一个信号队列。同一个进程的多个线程都共享同一个signal_struct。signal_struct包含了一个sigpending，这个sigpending代表进程的信号队列。

## 信号投递流程

普通发送和强制发送

### 强制发送

会先把信号的阻塞和忽略取消掉，再调用函数send_signal进行发送

### 普通发送

# 信号的处理

## 信号的阻塞

当一个线程正在处理一个关键的任务的时候，就可以暂时屏蔽信号，等任务完成之后就可以解决屏蔽了。信号屏蔽是线程局部的，每个线程都可以有自己私有信号屏蔽设置。pthread_sigmask

## 信号的忽略与捕获

signal和sigaction

## 异步信号安全

通过设置处理函数来捕获信号，但是之恶能调用异步信号安全的函数，很多函数都不是信号安全函数，比如在信号处理函数中不能调用printf。可以使用write。更多信号安全函数：[https://man7.org/linux/man-pages/man7/signal-safety.7.html](https://man7.org/linux/man-pages/man7/signal-safety.7.html%E3%80%82)

## 信号处理流程

信号处理是线程从内核空间返回用户空间的时候处理的。在架构代码里

# 信号处理的同步化

将异步信号的处理转为同步，转化的方法就是用一个函数来等信号，这样信号和线程执行的相对性就是固定的了，就相当于是同步信号了。等的方式有两种，一种是等待信号被处理，信号还是走前面所说的处理流程，另一种是等待信号并截获信号，信号被偷走了，就不会走上述处理流程了。

## 信号等待

pause和sigsuspend

pause会使当前的线程进入休眠状态，直到有信号到来，并且被处理完成之后，函数才会返回

sigsuspend接口更灵活，可以指定一个屏蔽信号及，线程在休眠的同时还能屏蔽不想等待的信号

## 信号截获

可以对截获到的信号进行相应的处理。
